# Portadoc Harmonization Configuration
# All thresholds are configurable - tune based on your document quality

harmonize:
  # IoU threshold for matching words across engines
  iou_threshold: 0.3

  # Text-aware matching: lower IoU threshold when text matches exactly
  # This helps match bboxes with slight offsets (PaddleOCR can have ~10px offset)
  text_match_bonus: 0.15

  # Center distance fallback: if text matches and centers within this distance,
  # treat as match even with very low IoU. Set to 0 to disable.
  # Based on analysis: PaddleOCR has up to 7px center offset on average
  center_distance_max: 12.0

  # Status thresholds (determines word/low_conf/pixel status)
  status:
    word_min_conf: 60.0           # >= this = "word" (trust text + bbox)
    low_conf_min_conf: 20.0       # >= this = "low_conf" (trust bbox only)
    # Below low_conf_min_conf = "pixel" (bbox region of interest)

  # Primary engine (Tesseract) settings
  primary:
    engine: tesseract
    weight: 1.0
    # All primary words included; status determined by confidence

  # Secondary engine settings
  secondary:
    vote_min_conf: 40.0           # Min conf to participate in text voting
    solo_min_conf: 92.0           # Min conf to add word without primary (raised to reduce FPs)
    solo_high_conf: 98.0          # Min conf to add without corroboration (raised)

    engines:
      easyocr:
        enabled: true
        weight: 0.9               # Good overall accuracy
        garbage_penalty: 0.1      # Multiplier when garbage detected
        bbox_type: word           # word-level bboxes
      doctr:
        enabled: true             # Best text accuracy (76.57%)
        weight: 1.1               # Highest text accuracy weight
        garbage_penalty: 0.1
        bbox_type: word
      paddleocr:
        enabled: true             # Good general performance
        weight: 0.8               # Mid-range weight
        garbage_penalty: 0.1
        bbox_type: word
      surya:
        enabled: true             # SOTA accuracy, word-level
        weight: 1.2               # Highest accuracy - trust Surya text
        garbage_penalty: 0.1
        bbox_type: word
        # Surya bboxes can be offset - use looser matching
        iou_threshold_override: 0.08  # Lower threshold for Surya
        center_distance_max_override: 50.0  # Allow larger center offset

  # Garbage text detection
  garbage_detection:
    enabled: true
    min_alnum_ratio: 0.6          # Minimum alphanumeric character ratio
    max_consonant_run: 4          # Max consecutive consonants before flagged
    mixed_case_penalty: true      # Penalize "ImLIudz" style text

# Engine-specific OCR settings
ocr:
  tesseract:
    psm: 6                        # Page segmentation mode (6 = uniform block)
    oem: 3                        # OCR engine mode (3 = default)

  easyocr:
    decoder: greedy               # greedy or beamsearch
    beamWidth: 5                  # Only used if decoder=beamsearch
    text_threshold: 0.7           # Detection confidence threshold
    low_text: 0.4                 # Text region threshold
    contrast_ths: 0.1             # Contrast threshold
    adjust_contrast: 0.5          # Contrast adjustment
    width_ths: 0.5                # Width threshold for merging
    mag_ratio: 1.0                # Internal upscaling ratio

  paddleocr:
    use_angle_cls: true
    lang: en
    use_gpu: false

  doctr:
    pretrained: true
    assume_straight_pages: true

# Page alignment (auto-rotation) settings
page_alignment:
  enabled: true                    # Master switch for page alignment
  method: auto                     # Detection method: tesseract_osd, surya, or auto (OSD with Surya fallback)
  min_confidence: 0.1              # Min confidence to apply rotation (0-1). OSD confidence is typically low (0.1-0.3) even for correct detections.
  angles: [90, 180, 270]           # Which rotations to detect/correct
  surya_fallback_threshold: 0.05   # If using "auto" method, use Surya when OSD confidence is below this

# Output settings
output:
  csv:
    include_all_engines: true     # Include raw text from all engines
    include_distances: true       # Include Levenshtein distances
    include_pixel_detections: true  # Include status=pixel rows
